<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Layout DSL Reference - Tren</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      line-height: 1.6;
      color: #333;
      max-width: 900px;
      margin: 0 auto;
      padding: 20px;
      background: #fafafa;
    }
    h1 {
      color: #2c3e50;
      border-bottom: 3px solid #3498db;
      padding-bottom: 10px;
      margin-bottom: 20px;
    }
    h2 {
      color: #2c3e50;
      margin-top: 30px;
      margin-bottom: 15px;
      border-bottom: 1px solid #ddd;
      padding-bottom: 5px;
    }
    h3 {
      color: #34495e;
      margin-top: 20px;
      margin-bottom: 10px;
    }
    p {
      margin-bottom: 12px;
    }
    pre {
      background: #2c3e50;
      color: #ecf0f1;
      padding: 15px;
      border-radius: 5px;
      overflow-x: auto;
      margin: 15px 0;
    }
    code {
      background: #e8e8e8;
      padding: 2px 6px;
      border-radius: 3px;
      font-family: 'Monaco', 'Menlo', 'Consolas', monospace;
      font-size: 0.9em;
    }
    pre code {
      background: none;
      padding: 0;
    }
    table {
      border-collapse: collapse;
      width: 100%;
      margin: 15px 0;
    }
    th, td {
      border: 1px solid #ddd;
      padding: 10px;
      text-align: left;
    }
    th {
      background: #3498db;
      color: white;
    }
    tr:nth-child(even) {
      background: #f5f5f5;
    }
    ul, ol {
      margin: 10px 0 10px 25px;
    }
    li {
      margin-bottom: 5px;
    }
    .back-link {
      display: inline-block;
      margin-bottom: 20px;
      color: #3498db;
      text-decoration: none;
    }
    .back-link:hover {
      text-decoration: underline;
    }
    .section {
      background: white;
      padding: 20px;
      border-radius: 8px;
      margin-bottom: 20px;
      box-shadow: 0 1px 3px rgba(0,0,0,0.1);
    }
  </style>
</head>
<body>
  <a href="index.html" class="back-link">&larr; Back to Simulator</a>

  <h1>Layout Definition Language (DSL)</h1>

  <div class="section">
    <h2>File Format</h2>
    <p>Layout files are plain text. Blank lines are ignored. Comments begin with <code>#</code>.</p>

    <h3>Statement Separators</h3>
    <p>Multiple statements can be placed on one line, separated by semicolons:</p>
    <pre><code># One statement per line
str
crvl
str

# Multiple statements on one line
str ; crvl ; str

# Inline comments
str          # This is a comment</code></pre>

    <h3>Layout Settings</h3>
    <p>Configure simulation behavior:</p>
    <pre><code>title My Railroad              # Layout name
description A test layout      # Description text
lockahead distance 15 count 3  # Lock ahead: 15 inches, 3 connection points
random                         # Switches change randomly when trains pass
max trains 5                   # Limit to at most 5 trains on the layout</code></pre>
    <p>The <code>lockahead</code> statement configures collision prevention: <code>distance N</code> sets how far ahead to scan (default 10 inches), <code>count N</code> sets minimum connection points to lock (default 2).</p>
    <p>The <code>random</code> statement enables automatic switch changes after each train passes, creating varied autonomous behavior ideal for demonstrations or computer art.</p>
    <p>The <code>max trains</code> statement limits the number of trains that can exist simultaneously (default: 5). Generators will not spawn new trains when the limit is reached. Trains destroyed by bins free up slots for new trains.</p>
  </div>

  <div class="section">
    <h2>Basic Syntax</h2>

    <h3>Placing Track Pieces</h3>
    <p>The simplest statement places a single track piece:</p>
    <pre><code>str          # Place a straight (9" default)
crvl         # Place a left curve (22" radius default)</code></pre>
    <p>Each piece connects to the previous piece: previous <code>out</code> &rarr; current <code>in</code></p>

    <h3>Piece Codes</h3>
    <table>
      <tr><th>Code</th><th>Description</th></tr>
      <tr><td><code>str</code>, <code>str9</code>, <code>str6</code>, <code>str3</code>, <code>str15</code></td><td>Straight sections (<code>str</code> = <code>str9</code>, 9" length)</td></tr>
      <tr><td><code>crv</code>, <code>crvl</code>, <code>crvl18</code>, <code>crvl22</code>, <code>crvl24</code></td><td>Left curves (<code>crv</code>/<code>crvl</code> = <code>crvl22</code>, 22" radius, 22.5&deg; arc)</td></tr>
      <tr><td><code>crvr</code>, <code>crvr18</code>, <code>crvr22</code>, <code>crvr24</code></td><td>Right curves (<code>crvr</code> = <code>crvr22</code>, 22" radius, 22.5&deg; arc)</td></tr>
      <tr><td><code>x90</code>, <code>x45</code></td><td>Crossings</td></tr>
      <tr><td><code>bump</code></td><td>Buffer stop</td></tr>
      <tr><td><code>ph</code>, <code>placeholder</code></td><td>Zero-length junction point</td></tr>
      <tr><td><code>gen</code>, <code>generator</code></td><td>Train source (see Generator Syntax below)</td></tr>
      <tr><td><code>bin</code></td><td>Train sink (removes trains)</td></tr>
      <tr><td><code>tun</code>, <code>tunnel</code></td><td>Visibility toggle</td></tr>
      <tr><td><code>sem</code>, <code>semaphore</code></td><td>Manual signal (see Semaphore Syntax below)</td></tr>
    </table>

    <h3>Repetition</h3>
    <p>Place multiple consecutive pieces:</p>
    <pre><code>str x 5      # Five straight pieces
crvl x 4     # Four left curves (90° total)
crvr * 8     # Eight right curves (180°)</code></pre>

    <h3>Generator Syntax</h3>
    <p>Generators spawn trains with configurable car counts and speed:</p>
    <pre><code>gen                           # One train: 1 cab, 5 cars, 12"/sec
gen cabs 2                    # One train: 2 cabs, 5 cars
gen cars 3                    # One train: 1 cab, 3 cars
gen speed 24                  # One train at 24 inches/second
gen cabs 2 cars 3             # One train: 2 cabs, 3 cars
gen cabs 2 cars 3 speed 6 every 15    # Full specification</code></pre>
    <p>Parameters: <code>cabs N</code> (default 1), <code>cars M</code> (default 5), <code>speed S</code> (default 12 inches/sec), <code>every S</code> (spawn interval in seconds).</p>
    <p>Without <code>every</code>, the generator spawns one train and disables. With <code>every N</code>, it spawns a new train every N seconds.</p>

    <h3>Range Values</h3>
    <p>Any parameter can use a range <code>LOW-HIGH</code> for randomization:</p>
    <pre><code>gen cabs 1-2 cars 3-8         # Random 1-2 cabs, 3-8 cars
gen speed 6-24                # Random speed (real number)
gen every 10-30               # Random spawn interval</code></pre>
    <p>Integer parameters (<code>cabs</code>, <code>cars</code>, <code>every</code>) get random integers. <code>speed</code> gets a random real number. Each spawned train gets its own random values.</p>

    <h3>Semaphore Syntax</h3>
    <p>Semaphores are manual signal points where you can control train traffic:</p>
    <pre><code>sem                           # Place a semaphore
semaphore                     # Same as sem (alias)
signal: sem                   # Labeled semaphore</code></pre>
    <p><strong>Visual appearance:</strong> A colored status dot inside a circle outline (same size as gen/bin).</p>
    <p><strong>Colors:</strong></p>
    <ul>
      <li><strong>Green dot</strong> = Unlocked (trains can pass)</li>
      <li><strong>Red dot</strong> = Locked (trains stop and wait)</li>
    </ul>
    <p><strong>Interaction:</strong> Click the dot to toggle between locked and unlocked. Semaphores start unlocked (green).</p>
    <p><strong>Use cases:</strong> Manual traffic control, creating holding points, simulating station stops.</p>
  </div>

  <div class="section">
    <h2>Labels and References</h2>

    <h3>Defining Labels</h3>
    <pre><code>start: str              # Label this straight as "start"
junction: ph            # Label this placeholder as "junction"</code></pre>

    <h3>Referencing Labels</h3>
    <pre><code>$start                  # Reference the piece labeled "start"
$junction.out           # Reference the "out" connection point
$junction.in            # Reference the "in" connection point</code></pre>
    <p>If no connection point is specified, <code>out</code> is the default.</p>
  </div>

  <div class="section">
    <h2>Branching (Virtual Switches)</h2>
    <p>Connect multiple pieces to the same point to create branches:</p>
    <pre><code>junction: ph            # Placeholder as junction point
str x 3
bump

$junction.out           # Return to junction's output
crvl x 3                # Branch curves left
bump</code></pre>
    <p>This creates a <strong>virtual switch</strong> where both routes connect to <code>junction.out</code>.</p>
  </div>

  <div class="section">
    <h2>Starting New Segments</h2>
    <p>The <code>new</code> statement begins a new track segment:</p>
    <pre><code>new                     # Start at origin, 0° rotation
new 45                  # Start at origin, rotated 45°
new from $label         # Start from label's 'out' point
new from $label.in      # Start from label's 'in' point
new $label.out          # Same ('from' is optional)
new from out.$label     # Alternative ordering (point.$label)</code></pre>

    <h3>Example: Sidetrack from Circle</h3>
    <pre><code>circle: ph
crvl x 16           # Circle from placeholder

new from $circle.out
gen                 # Generator connects to circle
str</code></pre>
  </div>

  <div class="section">
    <h2>Explicit Connection Syntax</h2>
    <p>Specify which end to attach using <code>point.piece</code> syntax:</p>
    <pre><code>out.str       # Attach str's OUT to current point (build backwards)
in.crvl       # Attach crvl's IN to current point (normal)</code></pre>

    <table>
      <tr><th>Syntax</th><th>Meaning</th></tr>
      <tr><td><code>str</code></td><td>Attach <code>in</code>, continue from <code>out</code> (default)</td></tr>
      <tr><td><code>out.str</code></td><td>Attach <code>out</code>, continue from <code>in</code></td></tr>
      <tr><td><code>in.str</code></td><td>Same as <code>str</code> (explicit default)</td></tr>
    </table>
  </div>

  <div class="section">
    <h2>Closing Loops</h2>
    <p>Use the <code>&gt;</code> operator to close a loop. Both syntaxes are equivalent:</p>
    <pre><code>start: str
crvl x 16               # Full circle of curves
> in.$start             # Close loop: connect to start's input
> $start.in             # Same effect, alternative syntax</code></pre>
  </div>

  <div class="section">
    <h2>Flex Connect</h2>
    <p>The <code>flex connect</code> statement creates custom track pieces to bridge gaps that can't be closed with standard pieces.</p>
    <pre><code>flex connect $label1.point1 $label2.point2</code></pre>
    <p>The solver automatically calculates the best solution to smoothly connect the two points:</p>
    <ul>
      <li><strong>Straight + Curve</strong> or <strong>Curve + Straight</strong> - for most gaps</li>
      <li><strong>Straight-only</strong> - when endpoints are collinear (same direction, aligned path)</li>
      <li><strong>Curve-only</strong> - when the straight portion would be very short (&lt;0.5")</li>
    </ul>

    <h3>Auto-Generated Labels</h3>
    <p>The created pieces are automatically labeled for later reference:</p>
    <ul>
      <li><code>{label1}_{label2}_str</code> - The straight piece (if created)</li>
      <li><code>{label1}_{label2}_crv</code> - The curve piece (if created)</li>
    </ul>
    <p>For example, <code>flex connect $f1.out $f2.in</code> creates <code>$f1_f2_str</code> and <code>$f1_f2_crv</code>.</p>
    <p><strong>Note:</strong> In edge cases, only one piece may be created (straight-only or curve-only).</p>

    <h3>Example</h3>
    <pre><code># Almost-complete loop
after: str
crvl * 4
str * 2
crvl * 5
str * 2
before: str

# Bridge the gap
flex connect $before.out $after.in

# Reference the flex pieces
$before_after_str.out
str x 2
bump</code></pre>

    <h3>Limitations</h3>
    <ul>
      <li>Minimum curve radius: 5 inches</li>
      <li>Minimum straight length: 0.5 inches (shorter creates curve-only)</li>
      <li>Maximum arc angle: 270 degrees</li>
      <li>If points are already at same position (distance ≈ 0), no bridge is created</li>
    </ul>

    <h3>Processing Order</h3>
    <p>Flex connects are processed after regular pieces but before auto-connect:</p>
    <ol>
      <li>Parse all statements</li>
      <li>Build regular track pieces</li>
      <li>Process splices</li>
      <li>Process cross connects</li>
      <li>Process flex connects (create bridge pieces)</li>
      <li>Auto-connect adjacent pieces</li>
    </ol>
  </div>

  <div class="section">
    <h2>Cross Connect</h2>
    <p>The <code>cross connect</code> statement creates a shared lockable point where two track pieces physically cross. Only one train can occupy the intersection at a time.</p>
    <pre><code>cross connect $label1 $label2</code></pre>

    <h3>How It Works</h3>
    <ul>
      <li>Finds where the two tracks intersect geometrically</li>
      <li>Adds a shared lock at the intersection point</li>
      <li>Trains must acquire the lock to pass through</li>
      <li>If another train holds the lock, the approaching train stops</li>
      <li>Original track pieces remain unchanged (no splitting)</li>
    </ul>

    <h3>Example</h3>
    <pre><code># Two tracks that cross
gen ; str x 3 ; one: str x 10 ; str x 3 ; bin

new 45
gen ; str x 3 ; two: str x 10 ; str x 3 ; bin

cross connect $one $two</code></pre>

    <h3>Difference from x90/x45 Crossings</h3>
    <p>Built-in crossings (<code>x90</code>, <code>x45</code>) are single pieces with two independent paths—trains can pass simultaneously. Cross connect works on any two existing pieces and uses locking to prevent simultaneous passage.</p>

    <h3>Error Handling</h3>
    <p>If the tracks don't actually intersect geometrically, a warning is logged and no lock is created. The layout continues to work normally.</p>
  </div>

  <div class="section">
    <h2>Auto-Connect</h2>
    <p>After a layout is built, connection points at the same position with opposite directions are automatically connected. This creates virtual switches where tracks meet.</p>
    <pre><code>crvl x 16               # Full circle - auto-connects at ends</code></pre>

    <h3>Visual Indicators</h3>
    <table>
      <tr><th>Indicator</th><th>Meaning</th></tr>
      <tr><td>Blue dot</td><td>Unconnected or explicitly connected point</td></tr>
      <tr><td>Yellow dot</td><td>Auto-connected point</td></tr>
      <tr><td>Green circle</td><td>Generator (train source)</td></tr>
      <tr><td>Red circle</td><td>Bin (train sink)</td></tr>
      <tr><td>Green dot in circle</td><td>Semaphore - unlocked (click to lock)</td></tr>
      <tr><td>Red dot in circle</td><td>Semaphore - locked (click to unlock)</td></tr>
      <tr><td>Green dot (small)</td><td>Selected route at virtual switch</td></tr>
      <tr><td>Red dot (small)</td><td>Unselected route at virtual switch (click to select)</td></tr>
      <tr><td>White sphere (small)</td><td>Connection point - unlocked (only visible when Labels is on)</td></tr>
      <tr><td>Red sphere (small)</td><td>Connection point - locked by a train (only visible when Labels is on)</td></tr>
      <tr><td>Text label</td><td>Labeled piece (from <code>label: piece</code> syntax)</td></tr>
    </table>
    <p><strong>Note:</strong> Connection point spheres (white/red) are only visible when the Labels button is active. Generator and bin pieces do not show connection point indicators.</p>

    <h3>Switch Interaction</h3>
    <p>At virtual switches (where multiple tracks connect to one point), click any route indicator to select that route. Trains will follow the selected route (green indicator).</p>
    <p><strong>Note:</strong> When a train is crossing a switch, the entire train will follow the route taken by the first car, even if you change the switch while the train is crossing.</p>
  </div>

  <div class="section">
    <h2>Connection Points Reference</h2>
    <table>
      <tr><th>Archetype</th><th>Connection Points</th><th>Default In</th><th>Default Out</th></tr>
      <tr><td><code>str*</code>, <code>crv*</code>, <code>flex</code></td><td><code>in</code>, <code>out</code></td><td><code>in</code></td><td><code>out</code></td></tr>
      <tr><td><code>x90</code>, <code>x45</code></td><td><code>in1</code>, <code>out1</code>, <code>in2</code>, <code>out2</code></td><td><code>in1</code></td><td><code>out1</code></td></tr>
      <tr><td><code>bump</code></td><td><code>in</code></td><td><code>in</code></td><td>(none)</td></tr>
      <tr><td><code>ph</code>, <code>tun</code></td><td><code>in</code>, <code>out</code></td><td><code>in</code></td><td><code>out</code></td></tr>
      <tr><td><code>gen</code></td><td><code>in</code>, <code>out</code></td><td><code>in</code></td><td><code>out</code></td></tr>
      <tr><td><code>bin</code></td><td><code>in</code>, <code>out</code></td><td><code>in</code></td><td><code>out</code></td></tr>
      <tr><td><code>sem</code></td><td><code>in</code>, <code>out</code></td><td><code>in</code></td><td><code>out</code></td></tr>
    </table>
  </div>

  <div class="section">
    <h2>Examples</h2>

    <h3>Simple Circle</h3>
    <pre><code>crvl x 16               # Full circle (auto-connects)</code></pre>

    <h3>Circle with Generator</h3>
    <pre><code>start: ph
crvl x 16

new
gen
str
$start.in</code></pre>

    <h3>Oval with Passing Siding</h3>
    <pre><code>start: str x 4
crvl x 8                # 180° turn
str x 4
crvl x 8                # 180° turn
> in.$start             # Close main loop

$start.out              # Branch from first straight
str x 4
> in.$start             # Rejoin</code></pre>
  </div>

  <div class="section">
    <h2>Toolbar Controls</h2>
    <table>
      <tr><th>Button</th><th>Function</th></tr>
      <tr><td><strong>Import Layout</strong></td><td>Open a layout file (.txt or .layout)</td></tr>
      <tr><td><strong>Random</strong></td><td>Toggle random switch mode (trains choose routes randomly)</td></tr>
      <tr><td><strong>Labels</strong></td><td>Toggle track labels AND connection point indicators (white=unlocked, red=locked)</td></tr>
    </table>
    <p>Active buttons are highlighted. You can also paste layout text directly into the window.</p>
  </div>

</body>
</html>
